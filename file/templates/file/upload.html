<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Upload</title>
</head>
<title>File Upload</title>
<style>
    body {
        background-color: whitesmoke;
        background-image: url("https://www.transparenttextures.com/patterns/lyonnette.png");
        border-bottom: 0 solid black;
        height: 450px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #FileUpload {
        display: flex;
        justify-content: center;
    }

    .remove-file {
        color: crimson;
    }

    .wrapper {
        margin: 30px;
        padding: 10px;
        box-shadow: 0 19px 38px rgba(0, 0, 0, 0.30), 0 15px 12px rgba(0, 0, 0, 0.22);
        border-radius: 10px;
        background-color: white;
        width: 415px;
    }

    .upload {
        margin: 10px;
        height: 85px;
        border: 8px dashed #e6f5e9;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
    }

    .upload p {
        margin-top: 12px;
        line-height: 0;
        font-size: 22px;
        color: #6d992e;
        letter-spacing: 1.5px;
    }


    #file-label {
        display: inline-block;
    }

    button[type="submit"] {
        background-color: #6d992e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 20px auto 0;
        display: block;
    }

    button[type="submit"]:hover {
        background-color: #0c3214;
    }

    #file-warning {
        color: red;
        display: none;
    }

    .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        align-items: center;
    }

    .nav-buttons button {
        width: 150px;
        background-color: #6d992e;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 0 20px;
        display: inline-block;
    }

    .nav-buttons button:hover {
        background-color: #0c3214;
    }


    #progress-container {
        display: none;
        align-items: center;
        width: 100%;
        background-color: #e6f5e9;
        height: 30px;
        border-radius: 5px;
        flex-direction: column;
    }

    #progress-bar {
        height: 100%;
        width: 0;
        background-color: #6d992e;
        border-radius: 5px;
        transition: width 0.3s ease;
    }

    #progress-text {
        margin-top: 5px;
        font-size: 14px;
        color: #6d992e;
    }
</style>
<body>
<div id="FileUpload">
    <div class="wrapper">
        <form id="upload-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="upload">
                <label for="file-input">
                    <p id="file-label">Select your files </p>
                </label>
                <input type="file" id="file-input" name="file" multiple style="display: none;">
            </div>
            <div id="file-queue" class="file-queue">
            </div>
            <button type="submit">Upload</button>
            <p id="file-warning">Please select one or more files to upload.</p>
        </form>
        <div class="nav-buttons" id="nav-buttons">
            <button type="button" onclick="window.location.href='/'"><i class="fas fa-home fa-xs"></i> Home</button>
            <button type="button" onclick="window.location.href='/file-list'"><i class="fas fa-file fa-xs"></i> Files</button>
        </div>
        <div id="progress-container">
            <div id="progress-bar"></div>
            <div id="progress-text">0%</div>
        </div>
    </div>
</div>
<script>
    let fileQueue = [];

    function addFileToQueue(file) {
        let fileQueueContainer = document.getElementById('file-queue');
        let fileItem = document.createElement('div');
        fileItem.classList.add('file-item');
        fileItem.innerHTML = `
        <span>${file.name}</span>
        <i class="fas fa-times remove-file" data-file="${file.name}"></i>
    `;
        fileItem.querySelector('.remove-file').addEventListener('click', function () {
            let fileName = this.getAttribute('data-file');
            fileQueue = fileQueue.filter(file => file.name !== fileName);
            fileQueueContainer.removeChild(fileItem);
        });
        fileQueue.push(file);
        fileQueueContainer.appendChild(fileItem);
    }

    document.getElementById('file-input').addEventListener('change', function () {
        let selectedFiles = this.files;
        let fileLabel = document.getElementById('file-label');
        Array.from(selectedFiles).forEach(file => {
            addFileToQueue(file);
        });
        fileLabel.innerHTML = fileQueue.length > 0 ? 'Select more files' : 'Select your files';
    });
    document.addEventListener('mouseover', function (event) {
        if (event.target && event.target.classList.contains('remove-file')) {
            event.target.style.cursor = 'pointer';
        }
    });
    document.getElementById('upload-form').addEventListener('submit', function (event) {
        event.preventDefault();
        let fileWarning = document.getElementById('file-warning');
        let progressContainer = document.getElementById('progress-container');
        let navButtons = document.getElementById('nav-buttons');
        if (fileQueue.length === 0) {
            fileWarning.style.display = 'block';
            return;
        }
        let formData = new FormData(this);
        let uploadPromises = [];
        fileQueue.forEach(file => {
            let fileFormData = new FormData();
            fileFormData.append('file', file);
            fileFormData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));
            let fileXhr = new XMLHttpRequest();
            let uploadPromise = new Promise((resolve, reject) => {
                fileXhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        let percentage = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('progress-bar').style.width = percentage + '%';
                        document.getElementById('progress-text').innerText = percentage + '%';
                        progressContainer.style.display = 'flex';
                        navButtons.style.display = 'none';
                    }
                });
                fileXhr.onload = function () {
                    if (fileXhr.status === 201) {
                        resolve();
                    } else {
                        reject(new Error('File upload failed'));  // Reject the promise on upload failure
                    }
                };
                fileXhr.open('POST', this.action, true);
                fileXhr.send(fileFormData);
            });
            uploadPromises.push(uploadPromise);
        });
        Promise.all(uploadPromises)
            .then(() => {
                window.location.href = '/upload/success/';
            })
            .catch(error => {
                console.error(error);
                alert('File upload failed.');
            });
        document.getElementById('upload-form').style.display = 'none';
        document.getElementById('file-warning').style.display = 'none';
    });
</script>
</body>
</html>
